---
title: "R数据科学学习笔记"
format: 
  html:
    theme: cosmo
    toc: true
    toc - depth: 3
    code-fold: true
---

# 1. Chapter 1

## My First R Code Chunk

my first R code chunk(@fig-penguins).

```{r}
#| label: fig-penguins
#| fig-cap: "Dimensions of penguins across three species."
#| fig-align: "center"
#| fig-alt: "Scatter plot showing the relationship between flipper length and bill length for three penguin species."
#| warning: false
library(tidyverse, quietly = TRUE)
library(palmerpenguins)
penguins |>
  ggplot(aes(x = flipper_length_mm, y = bill_length_mm)) +
  geom_point(aes(color = species))
```

## My First chunk parameters

```{r, echo=FALSE, message=FALSE}
#| label: fig-mpg
#| fig-cap: "Engine displacement vs. highway miles per gallon."
#| fig-alt: "A scatter plot showing the relationship between engine displacement and highway miles per gallon for various car models."
#| fig-align: "center"
library(ggplot2)
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point()
```

## DT Package Example

```{r}
#| label: table
#| tbl-cap: "使用 DT 包创建的交互式表格"
#| tbl-alt: "An interactive table displaying the mtcars dataset."
library(DT)
datatable(mtcars)
```

## gt Package Example

```{r}
#| fig-cap: "使用 gt 包创建的表格"

library(gt)

data <- data.frame(
  Name = c("Alice", "Bob", "Charlie"),
  Age = c(25, 30, 35),
  City = c("New York", "Los Angeles", "Chicago")
)

gt(data) %>%
  tab_header(
    title = "People Information",
    subtitle = "A list of people and their details"
  ) %>%
  fmt_number(columns = vars(Age), decimals = 0) %>%
  tab_source_note(source_note = "Data sourced from internal records")
```

## ggplot 中文字体显示需要安装 showtext 包

```{r}
library(showtext)
showtext_auto()
```

# 2. 使用dplyr包进行数据操作

## filter 行操作

### On-time data for all flights that departed NYC (i.e. JFK, LGA or EWR) in 2013.

```{r}
library(tidyverse)
library(nycflights13)
flights
glimpse(flights)
```

```{r}
# 过滤出2013年1月份从JFK机场出发的航班
jan_flights_jfk <- flights |>
  filter(month == 1, year == 2013, origin == "JFK")

filter(flights, month == 1 | month == 12)
filter(flights, carrier %in% c("AA", "DL", "UA"))
filter(flights, is.na(dep_time))
filter(flights, !(arr_delay > 120 | dep_delay > 120))
```

## arrange 行排序

```{r}
arrange(flights, year, month, day)

arrange(flights, desc(arr_delay))

```

## select 列选择

```{r}
select(flights, year, month, day)
select(flights, year:day)
select(flights, starts_with("dep"))
select(flights, ends_with("time"))
select(flights, contains("delay"))
select(flights, matches("^(dep|arr)_(delay|time)$")) # 正则表达式
select(flights, num_range("x", 1:3)) # 选择列名为 x1, x2, x3 的列

rename(flights, departure_time = dep_time, arrival_time = arr_time)

select(flights, flight, tailnum, everything())
select(flights, -c(year, month, day))
```

## mutate 新增列

```{r}
flights_sml <- select(
  flights,
  year:day,
  ends_with("delay"),
  distance,
  air_time
) |>
  mutate(
    gain = arr_delay - dep_delay,
    speed = distance / air_time * 60,
    .keep = 'used'
  )
flights_sml

transmute(
  flights,
  gain = arr_delay - dep_delay,
  hours = air_time / 60,
  gain_per_hour = gain / hours
)
```

![across](https://cdn.myportfolio.com/45214904-6a61-4e23-98d6-b140f8654a40/2471e3f8-348e-470c-a162-3eea0606ff96.png?h=b363a0827ba5f0f01a5a1d180c92a435)

![case_when](https://cdn.myportfolio.com/45214904-6a61-4e23-98d6-b140f8654a40/6ffcd6d6-c783-4087-ae76-99aa851663ed.png?h=cdc305bd6a2306b707493d9fd134ddba)

![](https://cdn.myportfolio.com/45214904-6a61-4e23-98d6-b140f8654a40/cb8d9c50-f48e-4c6d-a5b3-1d30ce0be2ad.png?h=2324beeb35f128adcdb4ab0e0996e706){fig-alt="filter"}

# dpylr across 示例
```{r}
library(tidyverse)
mpg |>
  mutate(across(
    where(is.character),
    as.factor
  )) |>
  glimpse()

```


```{r}
mpg |>
  mutate(across(
    where(is.character),
    as.factor
  )) |>
  mutate(
    size = case_when(
      displ < 2 ~ "small",
      displ >= 2 & displ < 4 ~ "medium",
      displ >= 4 ~ "large"
    )
  )

```


```{r}
mpg |>
  group_by(manufacturer) |>
  summarise(across(
    where(is.numeric) & contains('y'),
    mean
  ))

```


```{r}
library(tidyverse)
ggplot(data = starwars, mapping = aes(x = gender)) +
  geom_bar()
```


```{r}
starwars |>
  drop_na(height) |>
  ggplot(aes(height)) +
  geom_histogram()
```


```{r}
starwars |>
  drop_na(height) |>
  ggplot(aes(height)) +
  geom_boxplot(fill = 'steelblue') +
  theme_bw()
```


```{r}
#| label: hist-density-sex
#| fig-cap: "按性别叠加的直方图与密度曲线"
library(tidyverse)
library(plotly)
library(showtext)
showtext::showtext.auto()

df <- starwars |>
  drop_na(height) |>
  filter(sex %in% c("male", "female"))

p1 <- ggplot(df, aes(x = height, color = sex)) +
  geom_histogram(
    aes(y = after_stat(density), fill = sex),
    bins = 30,
    position = "identity",
    alpha = 0.4,
    color = NA
  ) +
  geom_density(linewidth = 1, alpha = 0.9, ) +
  facet_wrap(~sex) +
  labs(title = "直方图 + 密度曲线", x = "身高", y = "密度") +
  theme_minimal()

ggplotly(p1)
```

# data Analysis 
```{r}
library(tidyverse)
library(gapminder)

test <- gapminder |>
  mutate(year = as_factor(year)) |>
  filter(continent %in% c('Africa', 'Asia')) |>
  select(continent, year, lifeExp)
test
```

```{r}
library(gapminder)
library(dplyr)

# 筛选2007年三大洲数据，查看前5行
P1 <- gapminder %>%
  filter(continent %in% c("Africa", "Europe", "Asia"), year == 2007) %>%
  select(continent, lifeExp) %>%
  ggplot() +
  geom_density(
    mapping = aes(x = lifeExp, fill = continent, color = continent),
    alpha = 0.3,
  )
P1

```


```{r}
library(gapminder)
library(dplyr)

gapminder %>%
  filter(
    continent %in% c("Europe", "Asia"), # 仅保留两组
    year == 2007
  ) %>%
  t.test(lifeExp ~ continent, data = .) # 用 . 正确传递管道数据
```



```{r}
library(plotly)
library(tidyverse)
library(forcats)
view(msleep)
# Group the data by 'order' and calculate the mean sleep time for each group.
# Then, reorder the 'order' factor based on the mean sleep time for better visualization.
p1 <- msleep %>%
  group_by(order) %>%
  summarise(mean_sleep = mean(sleep_total)) %>%
  mutate(order = fct_reorder(order, mean_sleep)) %>%
  # Create the base ggplot with 'order' on x-axis and 'mean_sleep' on y-axis.
  ggplot(aes(x = order, y = mean_sleep)) +
  # Add labels for the plot title and y-axis, leave x-axis label empty.
  labs(title = "Sleep time of mammals", x = "", y = "Hours") +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    axis.text.y = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 25, face = "bold")
  ) +
  # Set canvas and label colors
  theme(
    axis.text.x = element_text(color = "lightblue"),
    axis.text.y = element_text(color = "lightblue"),
    axis.title.y = element_text(color = "lightblue"),
    plot.title = element_text(color = "lightblue"),
    axis.line = element_line(color = "lightblue"),
    axis.ticks = element_line(color = "lightblue"),
    panel.background = element_rect(fill = "darkblue"),
    plot.background = element_rect(fill = "darkblue"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none"
  ) +
  # Add a horizontal line for overall average sleep time.
  geom_hline(
    yintercept = mean(msleep$sleep_total),
    color = "lightblue",
    size = 1
  ) +
  # Add segments from the overall average to each group's mean.
  geom_segment(
    aes(
      x = order,
      y = mean(msleep$sleep_total),
      xend = order,
      yend = mean_sleep
    ),
    color = "lightblue"
  ) +
  # Add points for each group's mean sleep time, colored with a gradient.
  geom_point(aes(color = mean_sleep), size = 5) +
  scale_color_gradient(low = "hotpink", high = "yellow") +
  # Add an annotation text in the top left quadrant.
  # Add an annotation text in the top left quadrant.
  annotate(
    "text",
    x = 4,
    y = max(msleep$sleep_total) - 4,
    label = "Average sleep\nfor all mammals",
    color = "#f4cccc",
    size = 4,
    fontface = "bold",
    hjust = 0
  ) +
  # Add a curved arrow pointing to the horizontal line.
  geom_curve(
    aes(
      x = 3.7,
      y = max(msleep$sleep_total) - 5,
      xend = 1.5,
      yend = mean(msleep$sleep_total)
    ),
    color = "#f4cccc",
    curvature = 0.5,
    size = 0.5,
    arrow = arrow(length = unit(0.07, "npc"), type = "open")
  )

ggplotly(p1)
```


```{r}
library(gtExtras)
library(gapminder)
library(RColorBrewer)
library(svglite)

gapminder %>%
  rename(Country = country) %>%
  filter(continent == "Europe") %>%
  group_by(Country) %>%
  summarise(
    `GDP per capita` = round(mean(gdpPercap)),
    `Pop size` = round(mean(pop)),
    `Life expectance` = list(lifeExp)
  ) %>%
  arrange(-`GDP per capita`) %>%
  head(10) %>%
  gt() %>%
  gt_theme_pff() %>%
  gt_plt_dist('Life expectance') %>%
  gt_color_rows(column = 'Pop size', palette = "Pastel1") %>%
  gt_plt_bar_pct(
    'GDP per capita',
    fill = "steelblue",
    height = 15,
    width = 120
  ) %>%
  tab_header(title = "The GDP and Pop Size of Europe") %>%
  cols_align(align = "left")
```